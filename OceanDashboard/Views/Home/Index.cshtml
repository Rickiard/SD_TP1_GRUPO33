@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard Oceânico";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-center mb-3">Dashboard Oceânico</h1>
        </div>
        <div class="col-12">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <form id="dashboardFilters" method="get" asp-controller="Home" asp-action="Index" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="timeRange" class="form-label fw-medium">Período de Tempo</label>
                            <select id="timeRange" name="timeRange" class="form-select" asp-for="TimeRange">
                                <option value="1h">Última hora</option>
                                <option value="6h">Últimas 6 horas</option>
                                <option value="24h">Últimas 24 horas</option>
                                <option value="7d">Últimos 7 dias</option>
                                <option value="30d">Últimos 30 dias</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="stationId" class="form-label fw-medium">Estação</label>
                            <select id="stationId" name="stationId" class="form-select" asp-for="StationId">
                                <option value="all">Todas as estações</option>
                                @foreach (var station in Model.AvailableStations)
                                {
                                    <option value="@station">@station</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="resolution" class="form-label fw-medium">Resolução dos Dados</label>
                            <select id="resolution" name="resolution" class="form-select" asp-for="Resolution">
                                <option value="raw">Dados brutos</option>
                                <option value="minute">Por minuto</option>
                                <option value="hour">Por hora</option>
                                <option value="day">Por dia</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="analysisType" class="form-label fw-medium">Tipo de Análise</label>
                            <select id="analysisType" name="analysisType" class="form-select" asp-for="AnalysisType">
                                <option value="none">Sem análise</option>
                                <option value="all">Análise completa</option>
                                <option value="wave">Análise de ondas</option>
                                <option value="wind">Análise de ventos</option>
                                <option value="temperature">Análise de temperatura</option>
                            </select>
                        </div>
                        <div class="col-md-12 d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-filter"></i> Aplicar Filtros
                            </button>
                            <a href="#" id="exportDataBtn" class="btn btn-outline-secondary">
                                <i class="bi bi-download"></i> Exportar Dados
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Altura das Ondas</h6>
                            <h2 class="card-title mb-0">@Model.Summary.AverageWaveHeight.ToString("F1") m</h2>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-water"></i>
                        </div>
                    </div>
                    <div class="mt-3 d-flex justify-content-between">
                        <small>Máx: @Model.Summary.MaxWaveHeight.ToString("F1") m</small>
                        <small>Mediana: @Model.Summary.MedianWaveHeight.ToString("F1") m</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-success text-white h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Temperatura do Mar</h6>
                            <h2 class="card-title mb-0">@Model.Summary.AverageSeaTemperature.ToString("F1") °C</h2>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-thermometer-half"></i>
                        </div>
                    </div>
                    <div class="mt-3 d-flex justify-content-between">
                        <small>Min: @Model.Summary.MinSeaTemperature.ToString("F1") °C</small>
                        <small>Max: @Model.Summary.MaxSeaTemperature.ToString("F1") °C</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-dark h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Velocidade do Vento</h6>
                            <h2 class="card-title mb-0">@Model.Summary.AverageWindSpeed.ToString("F1") nós</h2>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-wind"></i>
                        </div>
                    </div>
                    <div class="mt-3 d-flex justify-content-between">
                        <small>Máx: @Model.Summary.MaxWindSpeed.ToString("F1") nós</small>
                        <small>StdDev: @Model.Summary.WindSpeedStdDev.ToString("F2")</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 opacity-75">Direção do Vento</h6>
                            <h2 class="card-title mb-0">@Model.Summary.MostCommonWindDirection</h2>
                        </div>
                        <div class="fs-1 opacity-50">
                            <i class="bi bi-compass"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small>Dados: @Model.Summary.DataPointsCount pontos de @Model.Summary.StationsCount estações</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Tabs -->
    <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab" aria-controls="charts" aria-selected="true">
                <i class="bi bi-bar-chart-line me-1"></i> Gráficos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rawdata-tab" data-bs-toggle="tab" data-bs-target="#rawdata" type="button" role="tab" aria-controls="rawdata" aria-selected="false">
                <i class="bi bi-table me-1"></i> Dados Brutos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab" aria-controls="analysis" aria-selected="false">
                <i class="bi bi-graph-up me-1"></i> Análise Avançada
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content mb-4" id="dashboardTabContent">
        <!-- Charts Tab -->
        <div class="tab-pane fade show active" id="charts" role="tabpanel" aria-labelledby="charts-tab">
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">Altura das Ondas</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container dashboard-chart">
                                <canvas id="waveHeightChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">Direção do Vento</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container dashboard-chart">
                                <canvas id="windDirectionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">Temperatura do Mar</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container dashboard-chart">
                                <canvas id="temperatureChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="card-title mb-0">Velocidade do Vento</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container dashboard-chart">
                                <canvas id="windSpeedChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Raw Data Tab -->
        <div class="tab-pane fade" id="rawdata" role="tabpanel" aria-labelledby="rawdata-tab">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="oceanDataTable">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Estação</th>
                                    <th>Sensor</th>
                                    <th>Altura das Ondas (m)</th>
                                    <th>Período (s)</th>
                                    <th>Velocidade do Vento (nós)</th>
                                    <th>Dir. Vento</th>
                                    <th>Temp. Mar (°C)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.OceanData.OrderByDescending(d => d.Timestamp).Take(100))
                                {
                                    <tr>
                                        <td>@item.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                        <td>@item.StationId</td>
                                        <td>@item.SensorId</td>
                                        <td>@item.WaveHeight.ToString("F2")</td>
                                        <td>@item.WavePeriod.ToString("F1")</td>
                                        <td>@item.WindSpeed.ToString("F1")</td>
                                        <td>@item.WindDirection.ToString("F0")°</td>
                                        <td>@item.SeaTemperature.ToString("F1")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Export options -->
                    <div class="d-flex justify-content-end mt-3">
                        <div class="btn-group">
                            <a href="@Url.Action("ExportData", "Export", new { format = "csv" })" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-filetype-csv me-1"></i> Exportar CSV
                            </a>
                            <a href="@Url.Action("ExportData", "Export", new { format = "json" })" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-filetype-json me-1"></i> Exportar JSON
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Tab -->
        <div class="tab-pane fade" id="analysis" role="tabpanel" aria-labelledby="analysis-tab">
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Análise de Padrões</h5>
                            <span class="badge bg-light text-dark">@(Model.AnalysisType == "none" ? "Análise Desativada" : $"Analisando {Model.AnalysisType}")</span>
                        </div>
                        <div class="card-body">
                            @if (Model.AnalysisType == "none")
                            {
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill me-2"></i> Selecione um tipo de análise nos filtros acima para visualizar padrões nos dados.
                                </div>
                            }
                            else if (Model.PatternAnalysisResult == null)
                            {
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i> Não foi possível conectar ao serviço de análise. Verifique se o RPC_DataAnalyserService está em execução.
                                </div>
                            }
                            else if (!Model.PatternAnalysisResult.Success)
                            {
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-circle-fill me-2"></i> Erro na análise: @Model.PatternAnalysisResult.ErrorMessage
                                </div>
                            }
                            else
                            {
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-3">Padrões Detectados</h6>
                                        @if (Model.PatternAnalysisResult.Patterns.Any())
                                        {
                                            <div class="list-group">
                                                @foreach (var pattern in Model.PatternAnalysisResult.Patterns.Take(5))
                                                {
                                                    <div class="list-group-item list-group-item-action">
                                                        <div class="d-flex w-100 justify-content-between">
                                                            <h6 class="mb-1">@pattern.Type</h6>
                                                            <small>@pattern.ConfidenceDisplay confiança</small>
                                                        </div>
                                                        <p class="mb-1">@pattern.Description</p>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small class="text-muted">@pattern.DurationDisplay</small>
                                                            <div class="intensity-wrapper">
                                                                @Html.Raw(pattern.IntensityBar)
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <p class="text-muted">Nenhum padrão detectado</p>
                                        }
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="fw-bold mb-3">Eventos de Tempestade</h6>
                                        @if (Model.PatternAnalysisResult.StormEvents.Any())
                                        {
                                            <div class="list-group">
                                                @foreach (var storm in Model.PatternAnalysisResult.StormEvents.Take(5))
                                                {
                                                    <div class="list-group-item list-group-item-action">
                                                        <div class="d-flex w-100 justify-content-between">
                                                            <h6 class="mb-1">@storm.Description</h6>
                                                            <small>@Html.Raw(storm.SeverityDisplay)</small>
                                                        </div>
                                                        <p class="mb-1">Altura máx: @storm.PeakWaveHeight.ToString("F1")m | Vento máx: @storm.PeakWindSpeed.ToString("F1") nós</p>
                                                        <small class="text-muted">@storm.DurationDisplay em @storm.Location</small>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <p class="text-muted">Nenhum evento de tempestade detectado</p>
                                        }
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <h6 class="fw-bold mb-3">Anomalias Detectadas</h6>
                                        @if (Model.PatternAnalysisResult.Anomalies.Any())
                                        {
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Timestamp</th>
                                                            <th>Parâmetro</th>
                                                            <th>Valor Esperado</th>
                                                            <th>Valor Real</th>
                                                            <th>Desvio</th>
                                                            <th>Confiança</th>
                                                            <th>Localização</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var anomaly in Model.PatternAnalysisResult.Anomalies)
                                                        {
                                                            <tr class="@(anomaly.IsSignificantAnomaly ? "table-danger" : "")">
                                                                <td>@anomaly.Timestamp.ToString("dd/MM HH:mm")</td>
                                                                <td>@anomaly.Parameter</td>
                                                                <td>@anomaly.ExpectedValue.ToString("F2")</td>
                                                                <td>@anomaly.ActualValue.ToString("F2")</td>
                                                                <td>@anomaly.DeviationDisplay</td>
                                                                <td>@anomaly.ConfidenceDisplay</td>
                                                                <td>@anomaly.Location</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                        else
                                        {
                                            <p class="text-muted">Nenhuma anomalia detectada</p>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
                            <select id="windowSize" class="form-select">
                                <option value="5">5 pontos</option>
                                <option value="10" selected>10 pontos</option>
                                <option value="20">20 pontos</option>
                                <option value="50">50 pontos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button id="detectPatterns" class="btn btn-primary w-100">Detectar Padrões</button>
                        </div>
                    </div>
                    
                    <div class="pattern-results mt-4" id="patternResults" style="display:none;">
                        <ul class="nav nav-tabs" id="patternTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="patterns-tab" data-bs-toggle="tab" data-bs-target="#patterns-content" type="button" role="tab">
                                    Padrões <span id="patternsCount" class="badge bg-primary">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="storms-tab" data-bs-toggle="tab" data-bs-target="#storms-content" type="button" role="tab">
                                    Tempestades <span id="stormsCount" class="badge bg-warning text-dark">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="anomalies-tab" data-bs-toggle="tab" data-bs-target="#anomalies-content" type="button" role="tab">
                                    Anomalias <span id="anomaliesCount" class="badge bg-danger">0</span>
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content pt-3" id="patternTabContent">
                            <!-- Patterns tab content -->
                            <div class="tab-pane fade show active" id="patterns-content" role="tabpanel">
                                <div id="patternsList" class="list-group pattern-list">
                                    <div class="text-center text-muted py-4" id="noPatternsMessage">Nenhum padrão detectado.</div>
                                </div>
                            </div>
                            
                            <!-- Storms tab content -->
                            <div class="tab-pane fade" id="storms-content" role="tabpanel">
                                <div id="stormsList" class="list-group pattern-list">
                                    <div class="text-center text-muted py-4" id="noStormsMessage">Nenhuma tempestade detectada.</div>
                                </div>
                            </div>
                            
                            <!-- Anomalies tab content -->
                            <div class="tab-pane fade" id="anomalies-content" role="tabpanel">
                                <div id="anomaliesList" class="list-group pattern-list">
                                    <div class="text-center text-muted py-4" id="noAnomaliesMessage">Nenhuma anomalia detectada.</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-3">
                            <button id="exportPatterns" class="btn btn-outline-secondary">
                                <i class="bi bi-file-earmark-arrow-down"></i> Exportar Padrões (CSV)
                            </button>
                        </div>
                    </div>
                    
                    <div id="patternLoader" class="text-center p-4 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Analisando dados e detectando padrões...</p>
                    </div>
                    
                    <div id="patternError" class="alert alert-danger mt-3 d-none">
                        <strong>Erro!</strong> <span id="patternErrorMessage"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-light">
                    <h5 class="card-title mb-0">Todos os Registos</h5>
                    <span class="badge bg-primary">Total: <span id="totalRegistos">@Model.Count</span> registos</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-sm align-middle" id="tabelaRegistos">
                            <thead class="table-secondary">
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Localização</th>
                                    <th>Temperatura (°C)</th>
                                    <th>Altura (m)</th>
                                    <th>Período (s)</th>
                                    <th>Direção (°)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- O conteúdo será preenchido via JS para suportar paginação -->
                            </tbody>
                        </table>
                        <nav>
                            <ul class="pagination justify-content-center mt-3" id="paginacaoTabela"></ul>
                        </nav>
                        <div id="mensagemSemDados" class="text-center text-muted mt-3" style="display:none;">Sem registos para mostrar.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <style>
        .dashboard-chart {
            min-height: 300px;
            height: 320px;
            max-height: 350px;
            width: 100%;
        }
        .dashboard-chart canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Pattern detection styles */
        .pattern-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .pattern-item {
            border-left: 4px solid #0d6efd;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        
        .pattern-item:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .pattern-item.trend-pattern { border-left-color: #0d6efd; }
        .pattern-item.cycle-pattern { border-left-color: #6f42c1; }
        
        .storm-item {
            border-left: 4px solid #fd7e14;
            margin-bottom: 12px;
        }
        
        .anomaly-item {
            border-left: 4px solid #dc3545;
            margin-bottom: 12px;
        }
        
        .anomaly-item.significant {
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        .intensity-bar {
            display: inline-block;
            width: 8px;
            height: 16px;
            background-color: #0d6efd;
            margin-right: 2px;
            border-radius: 1px;
        }
        
        .severity-indicator {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .severity-indicator.low { background-color: #0d6efd; color: white; }
        .severity-indicator.moderate-low { background-color: #0dcaf0; color: black; }
        .severity-indicator.moderate { background-color: #ffc107; color: black; }
        .severity-indicator.moderate-high { background-color: #fd7e14; color: white; }
        .severity-indicator.high { background-color: #dc3545; color: white; }
    </style>
}
